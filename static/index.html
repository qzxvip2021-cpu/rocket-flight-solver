<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rocket Flight Solver</title>

  <!-- ç§»åŠ¨ç«¯é€‚é… -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fafafa;
      color: #222;
    }

    h2 {
      margin-bottom: 12px;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      font-size: 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:active {
      background: #1e40af;
    }

    #plot {
      margin-top: 24px;
      width: 100%;
      min-height: 420px;
    }

    /* ===== Result Card ===== */
    #result-card {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      font-size: 15px;
      line-height: 1.6;
      display: none;
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
    }

    .ok {
      color: #16a34a;
      font-weight: 600;
    }

    .warn {
      color: #dc2626;
      font-weight: 600;
    }

    /* ===== History ===== */
    #history-card {
      margin-top: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      font-size: 13px;
    }

    .history-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .history-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    footer {
      margin-top: 32px;
      padding-top: 12px;
      border-top: 1px solid #ddd;
      font-size: 12px;
      color: #777;
      text-align: center;
      line-height: 1.6;
    }
  </style>
</head>

<body>
<div class="container">

  <h2>ðŸš€ Rocket Flight Solver</h2>

  <div class="form-group">
    <label>Engine</label>
    <select id="engine">
      <option>F20-4W</option>
      <option>F23-4FJ</option>
      <option>F42-4T</option>
      <option>F52-8C</option>
    </select>
  </div>

  <div class="form-group">
    <label>Temperature (Â°C)</label>
    <input id="temp" type="number" value="20">
  </div>

  <div class="form-group">
    <label>Pressure (hPa)</label>
    <input id="pressure" type="number" value="1015">
  </div>

  <div class="form-group">
    <label>Humidity (%)</label>
    <input id="humidity" type="number" value="50">
  </div>

  <div class="form-group">
    <label>Target apogee (ft)</label>
    <input id="target" type="number" value="750">
  </div>

  <button onclick="run()">Compute</button>

  <!-- Result -->
  <div id="result-card"></div>

  <!-- History -->
  <div id="history-card"></div>

  <!-- Plot -->
  <div id="plot"></div>

  <footer>
    Â© 2025 George Qiao. All rights reserved.<br>
    Rocket Flight Solver â€” for educational & competition use only.
  </footer>

</div>

<script>
async function run() {
  const payload = {
    engine: engine.value,
    temperature: +temp.value,
    pressure: +pressure.value,
    humidity: +humidity.value,
    target_apogee: +target.value
  };

  // ---------- fetch ----------
  const curve = await (await fetch("/curve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  const sol = await (await fetch("/solve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  // ---------- plot ----------
  Plotly.newPlot("plot", [
    { x: curve.mass, y: curve.apogee, mode: "lines", name: "Predicted apogee" },
    { x: curve.mass, y: curve.apogee_hi, line:{width:0}, showlegend:false },
    { x: curve.mass, y: curve.apogee_lo, fill:"tonexty", name:"Â±1Ïƒ confidence" },
    { x: [sol.mass], y: [sol.H_mean], mode:"markers", name:"Recommended mass" }
  ], {
    margin: { t: 40, l: 50, r: 20, b: 50 },
    xaxis: { title: "Liftoff mass (g)" },
    yaxis: { title: "Apogee (ft)" }
  });

  // ---------- result card ----------
  const card = document.getElementById("result-card");
  card.style.display = "block";

  const meets = sol.confidence >= 75;
  const flightTimeText = sol.flight_time != null
    ? `${sol.flight_time.toFixed(2)} s`
    : "N/A";

  card.innerHTML = `
    <div class="card-title">ðŸ“Š Computation Result</div>

    <div class="card-row"><span>Recommended mass</span><strong>${sol.mass.toFixed(1)} g</strong></div>
    <div class="card-row"><span>Predicted apogee</span><strong>${sol.H_mean.toFixed(1)} ft</strong></div>
    <div class="card-row"><span>Confidence</span><strong>${sol.confidence.toFixed(1)} %</strong></div>
    <div class="card-row"><span>Flight time</span><strong>${flightTimeText}</strong></div>

    <div style="margin-top:8px" class="${meets ? "ok" : "warn"}">
      ${meets ? "âœ” Meets 75% confidence requirement" : "âš  Below confidence requirement"}
    </div>
  `;

  // ---------- history ----------
  const record = {
    time: new Date().toLocaleString(),
    engine: payload.engine,
    target: payload.target_apogee,
    mass: sol.mass,
    confidence: sol.confidence
  };

  let history = JSON.parse(localStorage.getItem("rocket_history") || "[]");
  history.unshift(record);
  history = history.slice(0, 5);
  localStorage.setItem("rocket_history", JSON.stringify(history));

  const historyCard = document.getElementById("history-card");
  historyCard.innerHTML = `
    <div class="history-title">ðŸ“œ Recent Runs</div>
    ${history.map(h => `
      <div class="history-item">
        <div><strong>${h.engine}</strong> @ ${h.time}</div>
        <div>Target ${h.target} ft â†’ <strong>${h.mass.toFixed(1)} g</strong> (${h.confidence.toFixed(1)}%)</div>
      </div>
    `).join("")}
  `;
}
</script>

</body>
</html>
