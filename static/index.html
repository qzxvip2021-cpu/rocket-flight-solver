<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rocket Flight Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px;
    }

    h1 {
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    /* ---------- Input ---------- */

    .input-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      align-items: end;
    }

    label {
      font-size: 12px;
      color: #6b7280;
      display: block;
      margin-bottom: 4px;
    }

    select, input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
    }

    /* ---------- Result ---------- */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .kpi {
      text-align: center;
      padding: 16px;
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff, #f2f4f8);
    }

    .kpi-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
    }

    .model-meta {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* ---------- Plot ---------- */

    #plot {
      height: 420px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>üöÄ Rocket Flight Solver</h1>

  <!-- ================= Input ================= -->
  <div class="card">
    <div class="input-grid">

      <div>
        <label>Engine</label>
        <select id="engine">
          <option>F20-4W</option>
        </select>
      </div>

      <div>
        <label>Temperature (¬∞C)</label>
        <input id="temp" value="20">
      </div>

      <div>
        <label>Pressure (hPa)</label>
        <input id="pressure" value="1015">
      </div>

      <div>
        <label>Humidity (%)</label>
        <input id="humidity" value="50">
      </div>

      <div>
        <label>Target Apogee (ft)</label>
        <input id="target" value="750">
      </div>

    </div>

    <div style="margin-top: 16px;">
      <button class="btn-primary" id="compute-btn" onclick="run()">Compute</button>
      <button class="btn-secondary" onclick="submitFlight()">Submit Flight Data</button>
    </div>
  </div>

  <!-- ================= Result ================= -->
  <div class="card">
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label">Recommended Mass</div>
        <div class="kpi-value" id="kpi-mass">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Predicted Apogee</div>
        <div class="kpi-value" id="kpi-apogee">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Confidence</div>
        <div class="kpi-value" id="kpi-confidence">‚Äì</div>
      </div>
    </div>

    <div class="hint">
      Confidence = probability that apogee falls within ¬±25 ft of target.
    </div>

    <!-- ‚ë° Ê®°Âûã‰ø°ÊÅØÔºàËã•ÂêéÁ´ØÊúâÂàôÊòæÁ§∫Ôºâ -->
    <div class="model-meta" id="model-meta"></div>
  </div>

  <!-- ================= Plot ================= -->
  <div class="card">
    <div id="plot"></div>
  </div>

</div>

<script>
function confidenceColor(p) {
  if (p > 80) return "#16a34a";
  if (p > 60) return "#2563eb";
  if (p > 40) return "#f59e0b";
  return "#dc2626";
}

async function run() {
  const btn = document.getElementById("compute-btn");
  btn.disabled = true;
  btn.innerText = "Computing‚Ä¶";

  const payload = {
    engine: engine.value,
    temperature: +temp.value,
    pressure: +pressure.value,
    humidity: +humidity.value,
    target_apogee: +target.value
  };

  const curve = await (await fetch("/api/curve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  const sol = await (await fetch("/api/solve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  window.lastResult = sol;

  /* ================= ‚ë† ¬±œÉ Âå∫Èó¥ ================= */
  const bandX = [...curve.mass, ...curve.mass.slice().reverse()];
  const bandY = [...curve.apogee_hi, ...curve.apogee_lo.slice().reverse()];

  Plotly.newPlot("plot", [
    {
      x: curve.mass,
      y: curve.apogee,
      mode: "lines",
      name: "Apogee Curve"
    },
    {
      x: bandX,
      y: bandY,
      fill: "toself",
      fillcolor: "rgba(59,130,246,0.15)",
      line: { width: 0 },
      name: "¬±œÉ Uncertainty"
    },
    {
      x: curve.mass,
      y: curve.mass.map(() => curve.H_target),
      mode: "lines",
      line: { dash: "dash", color: "red" },
      name: "Target Apogee"
    },
    {
      x: [sol.mass],
      y: [sol.H_mean],
      mode: "markers",
      marker: { size: 12, color: "#16a34a" },
      name: "Recommended"
    }
  ], {
    title: "Apogee vs Liftoff Mass",
    xaxis: { title: "Liftoff Mass (g)" },
    yaxis: { title: "Apogee (ft)" }
  });

  document.getElementById("kpi-mass").innerText =
    sol.mass.toFixed(1) + " g";

  document.getElementById("kpi-apogee").innerText =
    sol.H_mean.toFixed(1) + " ft";

  const c = sol.confidence;
  const confEl = document.getElementById("kpi-confidence");
  confEl.innerText = c.toFixed(1) + " %";
  confEl.style.color = confidenceColor(c);

  /* ================= ‚ë° Ê®°Âûã‰ø°ÊÅØÔºàËã•Â≠òÂú®Ôºâ ================= */
  try {
    const info = await (await fetch("/api/model_info")).json();
    document.getElementById("model-meta").innerText =
      `Model ${info.engine} ¬∑ n=${info.meta?.n_height ?? "?"} ¬∑ œÉ=${info.sigma_H?.toFixed(1) ?? "?"} ft ¬∑ v${info.version}`;
  } catch {
    document.getElementById("model-meta").innerText =
      "Model information unavailable";
  }

  btn.disabled = false;
  btn.innerText = "Compute";
}

/* ================= ‚ë£ Êèê‰∫§ÂâçÁ°ÆËÆ§ÂºπÁ™ó ================= */
async function submitFlight() {
  if (!window.lastResult) {
    alert("Please compute first");
    return;
  }

  const summary = `
Engine: ${engine.value}
Mass: ${window.lastResult.mass.toFixed(1)} g
Apogee: ${window.lastResult.H_mean.toFixed(1)} ft
Confidence: ${window.lastResult.confidence.toFixed(1)} %
`;

  if (!confirm("Submit this flight data?\n\n" + summary)) {
    return;
  }

  const password = prompt("Enter team password:");
  if (!password) return;

  const payload = {
    password: password,
    engine: engine.value,
    liftoff_mass: window.lastResult.mass,
    apogee: window.lastResult.H_mean,
    flight_time: window.lastResult.flight_time,
    temperature: +temp.value,
    pressure: +pressure.value,
    humidity: +humidity.value
  };

  const resp = await fetch("/api/submit_flight", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    const err = await resp.json();
    alert("Submit failed: " + err.detail);
    return;
  }

  alert("‚úÖ Submitted for review");
}
</script>

</body>
</html>
