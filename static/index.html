<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rocket Flight Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px;
    }

    h1 {
      margin-bottom: 20px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .lang-select {
      font-size: 13px;
      padding: 4px 6px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      align-items: end;
    }

    label {
      font-size: 12px;
      color: #6b7280;
      display: block;
      margin-bottom: 4px;
    }

    select, input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .kpi {
      text-align: center;
      padding: 16px;
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff, #f2f4f8);
    }

    .kpi-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
    }

    .model-meta {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    #plot {
      height: 420px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    footer {
      margin: 40px 0 20px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- ===== Top bar ===== -->
  <div class="top-bar">
    <h1 data-i18n="title">ðŸš€ Rocket Flight Solver</h1>

    <select class="lang-select" onchange="setLang(this.value)">
      <option value="en">English</option>
      <option value="zh">ä¸­æ–‡</option>
      <option value="es">EspaÃ±ol</option>
    </select>
  </div>

  <!-- ================= Input ================= -->
  <div class="card">
    <div class="input-grid">

      <div>
        <label data-i18n="engine">Engine</label>
        <select id="engine">
          <option>F20-4W</option>
        </select>
      </div>

      <div>
        <label data-i18n="temperature">Temperature (Â°C)</label>
        <input id="temp" value="20">
      </div>

      <div>
        <label data-i18n="pressure">Pressure (hPa)</label>
        <input id="pressure" value="1015">
      </div>

      <div>
        <label data-i18n="humidity">Humidity (%)</label>
        <input id="humidity" value="50">
      </div>

      <div>
        <label data-i18n="target">Target Apogee (ft)</label>
        <input id="target" value="750">
      </div>

    </div>

    <div style="margin-top: 16px;">
      <button class="btn-primary" id="compute-btn" onclick="run()" data-i18n="compute">
        Compute
      </button>
      <button class="btn-secondary" onclick="submitFlight()" data-i18n="submit">
        Submit Flight Data
      </button>
    </div>
  </div>

  <!-- ================= Result ================= -->
  <div class="card">
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label" data-i18n="mass">Recommended Mass</div>
        <div class="kpi-value" id="kpi-mass">â€“</div>
      </div>
      <div class="kpi">
        <div class="kpi-label" data-i18n="apogee">Predicted Apogee</div>
        <div class="kpi-value" id="kpi-apogee">â€“</div>
      </div>
      <div class="kpi">
        <div class="kpi-label" data-i18n="confidence">Confidence</div>
        <div class="kpi-value" id="kpi-confidence">â€“</div>
      </div>
    </div>

    <div class="hint" data-i18n="confidence_hint">
      Confidence = probability that apogee falls within Â±25 ft of target.
    </div>

    <div class="model-meta" id="model-meta"></div>
  </div>

  <!-- ================= Plot ================= -->
  <div class="card">
    <div id="plot"></div>
  </div>

  <!-- ===== Footer (Version A) ===== -->
  <footer>
    Â© 2025 George Qiao Â· Educational & Competition Use Only
  </footer>

</div>

<script>
/* ================= i18n ================= */

const I18N = {
  en: {
    title: "ðŸš€ Rocket Flight Solver",
    engine: "Engine",
    temperature: "Temperature (Â°C)",
    pressure: "Pressure (hPa)",
    humidity: "Humidity (%)",
    target: "Target Apogee (ft)",
    compute: "Compute",
    submit: "Submit Flight Data",
    mass: "Recommended Mass",
    apogee: "Predicted Apogee",
    confidence: "Confidence",
    confidence_hint:
      "Confidence = probability that apogee falls within Â±25 ft of target."
  },
  zh: {
    title: "ðŸš€ ç«ç®­é£žè¡Œæ±‚è§£å™¨",
    engine: "å‘åŠ¨æœº",
    temperature: "æ¸©åº¦ (Â°C)",
    pressure: "æ°”åŽ‹ (hPa)",
    humidity: "æ¹¿åº¦ (%)",
    target: "ç›®æ ‡é¡¶ç‚¹é«˜åº¦ (ft)",
    compute: "è®¡ç®—",
    submit: "æäº¤é£žè¡Œæ•°æ®",
    mass: "æŽ¨èèµ·é£žè´¨é‡",
    apogee: "é¢„æµ‹é¡¶ç‚¹é«˜åº¦",
    confidence: "å‘½ä¸­æ¦‚çŽ‡",
    confidence_hint:
      "å‘½ä¸­æ¦‚çŽ‡ = é¡¶ç‚¹é«˜åº¦è½åœ¨ç›®æ ‡ Â±25 è‹±å°ºèŒƒå›´å†…çš„æ¦‚çŽ‡ã€‚"
  },
  es: {
    title: "ðŸš€ Solucionador de Vuelo de Cohetes",
    engine: "Motor",
    temperature: "Temperatura (Â°C)",
    pressure: "PresiÃ³n (hPa)",
    humidity: "Humedad (%)",
    target: "Apogeo Objetivo (ft)",
    compute: "Calcular",
    submit: "Enviar Datos de Vuelo",
    mass: "Masa Recomendada",
    apogee: "Apogeo Predicho",
    confidence: "Confianza",
    confidence_hint:
      "La confianza es la probabilidad de que el apogeo estÃ© dentro de Â±25 ft del objetivo."
  }
};

function setLang(lang) {
  const dict = I18N[lang] || I18N.en;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) el.innerText = dict[key];
  });
}

/* ================= Solver Logicï¼ˆåŽŸæ ·ä¿ç•™ï¼‰ ================= */

function confidenceColor(p) {
  if (p > 80) return "#16a34a";
  if (p > 60) return "#2563eb";
  if (p > 40) return "#f59e0b";
  return "#dc2626";
}

async function run() {
  const btn = document.getElementById("compute-btn");
  btn.disabled = true;
  btn.innerText = "Computingâ€¦";

  const payload = {
    engine: engine.value,
    temperature: +temp.value,
    pressure: +pressure.value,
    humidity: +humidity.value,
    target_apogee: +target.value
  };

  const curve = await (await fetch("/api/curve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  const sol = await (await fetch("/api/solve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })).json();

  window.lastResult = sol;

  const bandX = [...curve.mass, ...curve.mass.slice().reverse()];
  const bandY = [...curve.apogee_hi, ...curve.apogee_lo.slice().reverse()];

  Plotly.newPlot("plot", [
    { x: curve.mass, y: curve.apogee, mode: "lines", name: "Apogee Curve" },
    {
      x: bandX,
      y: bandY,
      fill: "toself",
      fillcolor: "rgba(59,130,246,0.15)",
      line: { width: 0 },
      name: "Â±Ïƒ"
    },
    {
      x: curve.mass,
      y: curve.mass.map(() => curve.H_target),
      mode: "lines",
      line: { dash: "dash", color: "red" },
      name: "Target"
    },
    {
      x: [sol.mass],
      y: [sol.H_mean],
      mode: "markers",
      marker: { size: 12, color: "#16a34a" },
      name: "Recommended"
    }
  ]);

  document.getElementById("kpi-mass").innerText = sol.mass.toFixed(1) + " g";
  document.getElementById("kpi-apogee").innerText = sol.H_mean.toFixed(1) + " ft";

  const confEl = document.getElementById("kpi-confidence");
  confEl.innerText = sol.confidence.toFixed(1) + " %";
  confEl.style.color = confidenceColor(sol.confidence);

  btn.disabled = false;
  btn.innerText = I18N.en.compute;
}

async function submitFlight() {
  if (!window.lastResult) {
    alert("Please compute first");
    return;
  }

  if (!confirm("Submit this flight data?")) return;

  const password = prompt("Enter team password:");
  if (!password) return;

  const payload = {
    password,
    engine: engine.value,
    liftoff_mass: window.lastResult.mass,
    apogee: window.lastResult.H_mean,
    flight_time: window.lastResult.flight_time,
    temperature: +temp.value,
    pressure: +pressure.value,
    humidity: +humidity.value
  };

  const resp = await fetch("/api/submit_flight", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    alert("Submit failed");
    return;
  }

  alert("âœ… Submitted for review");
}
</script>

</body>
</html>
